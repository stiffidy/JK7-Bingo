<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jura Kalniņa Bingo</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="main-container">

        <div class="bingo-container">
            <div class="bingo-card" id="bingo-card"></div>
        </div>

        <div class="controls-container">
            <h1 class="bingo-header">Jura Kalniņa Bingo</h1>
            <div class="frame" id="info">Seed: <span id="seed-display"></span></div>
            <div class="frame timer" id="timer">Time: Click any card to start the timer</div>
            <button id="generate-button" class="styled-button">Generate New Card</button>
        </div>
    </div>

    <div class="popup" id="popup">
        <h2>Rohs!</h2>
        <button onclick="closePopup()">Close</button>
    </div>

    <div class="overlay" id="overlay"></div>

    <audio id="click-sound" src="he.mp3" preload="auto"></audio>

    <script>
        const bingoCard = document.getElementById('bingo-card');
        const seedDisplay = document.getElementById('seed-display');
        const timerDisplay = document.getElementById('timer');
        const popup = document.getElementById('popup');
        const overlay = document.getElementById('overlay');
        const generateButton = document.getElementById('generate-button');
        const clickSound = document.getElementById('click-sound');

        let elapsedSeconds = 0;
        let timerInterval;
        let timerStarted = false;
        let gameWon = false;

        async function fetchBingoItems() {
            const response = await fetch('bingo_items.json');
            return await response.json();
        }

        function generateSeed() {
            return Math.random().toString(36).substring(2, 10);
        }

        function resetTimer() {
            clearInterval(timerInterval);
            elapsedSeconds = 0;
            timerStarted = false;
            timerDisplay.textContent = 'Time: Click any card to start the timer';
        }

        function startTimer() {
            if (timerStarted) return;
            timerStarted = true;
            timerInterval = setInterval(() => {
                elapsedSeconds++;
                timerDisplay.textContent = `Elapsed Time: ${elapsedSeconds}s`;
            }, 1000);
        }

        async function generateCard() {
            const bingoItems = await fetchBingoItems();
            const seed = generateSeed();
            seedDisplay.textContent = seed;

            const seededRandom = mulberry32(hashCode(seed));
            const shuffledItems = [...bingoItems].sort(() => seededRandom() - 0.5);
            const selectedItems = shuffledItems.slice(0, 25);

            bingoCard.innerHTML = '';
            selectedItems.forEach((item, index) => {
                const cell = document.createElement('div');
                cell.classList.add('bingo-cell');

                if (index === 12) {
                    const img = document.createElement('img');
                    img.src = 'free-spot.jpg';
                    img.alt = 'FREE';
                    cell.appendChild(img);

                    const overlayText = document.createElement('div');
                    overlayText.classList.add('overlay-text');
                    overlayText.textContent = 'FREE';
                    cell.appendChild(overlayText);

                    cell.classList.add('free', 'marked');
                } else {
                    cell.textContent = item;
                }

                cell.onclick = () => {
                    if (!gameWon && !cell.classList.contains('free')) {
                        cell.classList.toggle('marked');
                        startTimer();
                        clickSound.play();
                        checkWin();
                    }
                };

                bingoCard.appendChild(cell);
            });

            resetTimer();
            gameWon = false;
        }

        function checkWin() {
            const cells = Array.from(bingoCard.children);
            const isMarked = (index) => cells[index].classList.contains('marked');

            for (let i = 0; i < 5; i++) {
                if ([0, 1, 2, 3, 4].map(j => i * 5 + j).every(isMarked)) return showPopup();
                if ([0, 1, 2, 3, 4].map(j => i + j * 5).every(isMarked)) return showPopup();
            }

            if ([0, 6, 12, 18, 24].every(isMarked) || [4, 8, 12, 16, 20].every(isMarked)) {
                showPopup();
            }
        }

        function showPopup() {
            popup.style.display = 'block';
            overlay.style.display = 'block';
            clearInterval(timerInterval);
            gameWon = true;
        }

        function closePopup() {
            popup.style.display = 'none';
            overlay.style.display = 'none';
        }

        function hashCode(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = (hash << 5) - hash + char;
                hash |= 0;
            }
            return hash;
        }

        function mulberry32(seed) {
            return function () {
                let t = (seed += 0x6d2b79f5);
                t = Math.imul(t ^ (t >>> 15), t | 1);
                t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
                return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
            };
        }

        generateButton.onclick = generateCard;
        window.onload = generateCard;
    </script>
</body>
</html>